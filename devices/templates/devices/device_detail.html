<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Результаты по устройству</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">{% csrf_token %}

<!-- Кнопка возврата в левом верхнем углу -->
<a href="{% url 'device_search' %}"
   class="btn btn-primary position-fixed top-0 start-0 m-3"
   style="z-index: 1050;">
    ← Назад на главную
</a>



<div class="container my-5">

    <h1 class="mb-4">Результаты по устройству</h1>

    <!-- Блок 1: Информация об устройстве -->
    <div class="card mb-4">
        <div class="card-header fw-bold">Информация об устройстве</div>
        <div class="card-body">
            <p><strong>Модель устройства:</strong> {{ device.model }}</p>
            <p><strong>Производитель:</strong> {{ device.manufacturer }}</p>
            <a href="{% url 'admin:devices_device_change' device.id %}" class="btn btn-outline-secondary btn-sm">Редактировать</a>
        </div>
    </div>

    <!-- Блок 2: Документация -->
    <div class="card mb-4">
        <div class="card-header fw-bold">Документация</div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Тип документа</th>
                        <th>Статус</th>
                        <th>Путь к файлу / URL</th>
                        <th>Источник</th>
                    </tr>
                </thead>
                <tbody>
                {% for doc in documentation %}
                    <tr>
                        <td>{{ doc.get_doc_type_display }}</td>
                        <td>{% if doc.status %}✅ Найден{% else %}❌ Нет{% endif %}</td>
                        <td>
                            {% if doc.file_path %}
                                <a href="{{ doc.file_path.url }}" target="_blank">Скачать</a>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>Локально</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4" class="text-muted">Нет данных</td></tr>
                {% endfor %}
                </tbody>
            </table>
            <a href="{% url 'admin:devices_documentation_add' %}" class="btn btn-outline-primary btn-sm">Загрузить документ</a>
        </div>
    </div>

    <!-- Блок 3: Логины и пароли -->
    <div class="card mb-4">
        <div class="card-header fw-bold">Логины и пароли</div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Тип доступа</th>
                        <th>Login</th>
                        <th>Пароль</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                {% for auth in auth_data %}
                    <tr>
                        <td>{{ auth.get_access_type_display }}</td>
                        <td>{{ auth.login }}</td>
                        <td>{{ auth.password }}</td>
                        <td>
                            <a href="#" class="btn btn-sm btn-outline-secondary disabled">Редактировать</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4" class="text-muted">Нет данных</td></tr>
                {% endfor %}
                </tbody>
            </table>

            <!-- Форма для извлечения логина и пароля из PDF -->
            <form action="{% url 'extract_auth' device.id %}" method="post" id="pdf-form">
              {% csrf_token %}
              <button class="btn btn-primary" type="submit">Извлечь логин/пароль из PDF</button>
            </form>

            <div id="pdf-wait-message" class="alert alert-info mt-3" style="display: none;" role="alert">
              ⏳ Пожалуйста, подождите... Идёт извлечение логина и пароля из PDF.
            </div>

        </div>
    </div>

    <!-- Блок 4: Проверка доступности -->
   <!-- Блок 4: Проверка доступности -->
<div class="mb-4">
    <p><strong>IP-адрес:</strong>
      <span id="ping-status">
        {% if device.ip_address %}
          <span class="text-success">{{ device.ip_address }} ✅</span>
        {% else %}
          <span class="text-danger">нет IP-адреса ❌</span>
        {% endif %}
      </span>
    </p>


    <p><strong>CLI:</strong> <span class="text-muted">авторизация успешна / ошибка</span></p>
</div>

<!-- Кнопка Пинг -->
<button id="ping-btn" class="btn btn-outline-secondary btn-sm"
        {% if not device.ip_address %}disabled{% endif %}>
    Пинг
</button>
<div id="ping-result" class="mt-2"></div>

<script>
document.getElementById('ping-btn')?.addEventListener('click', () => {
    const deviceId = {{ device.id }};
    fetch(`/device/${deviceId}/ping/`)
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('ping-result');
            resultDiv.textContent = data.status;
            resultDiv.style.color = data.status.includes("Доступен") ? "green" :
                                    data.status.includes("Недоступен") ? "red" : "gray";

            const statusSpan = document.getElementById('ping-status');
            if (data.status.includes("Доступен")) {
                statusSpan.innerHTML = '<span class="text-success">✅ {{ device.ip_address }} доступен</span>';
            } else if (data.status.includes("Недоступен")) {
                statusSpan.innerHTML = '<span class="text-danger">❌ {{ device.ip_address }} недоступен </span>';
            } else {
                statusSpan.innerHTML = '<span class="text-muted">нет IP-адреса</span>';
            }
        })
        .catch(() => {
            const resultDiv = document.getElementById('ping-result');
            resultDiv.textContent = "Ошибка при проверке";
            resultDiv.style.color = "orange";

            const statusSpan = document.getElementById('ping-status');
            statusSpan.innerHTML = '<span class="text-warning">⚠ ошибка</span>';
        });
});
</script>


    <p><strong>Доступность порта Web:</strong> <span id="web-status" class="text-muted">Доступен/ ошибка</span></p>
    <button id="web-btn" class="btn btn-outline-primary btn-sm">Проверить Web</button>
    <div id="web-result" class="mt-2 small text-muted"></div>

    <script>
    document.getElementById('web-btn').addEventListener('click', () => {
        const deviceId = {{ device.id }};
        fetch(`/device/${deviceId}/webcheck/`)
            .then(response => response.json())
            .then(data => {
                const statusSpan = document.getElementById('web-status');
                const resultDiv = document.getElementById('web-result');

                if (data.status.includes("Доступен")) {
                    statusSpan.textContent = "✅ доступен";
                    statusSpan.className = "text-success";
                } else {
                    statusSpan.textContent = "❌ недоступен";
                    statusSpan.className = "text-danger";
                }

                resultDiv.textContent = data.status;
            })
            .catch(() => {
                const statusSpan = document.getElementById('web-status');
                statusSpan.textContent = "⚠ ошибка";
                statusSpan.className = "text-warning";

                const resultDiv = document.getElementById('web-result');
                resultDiv.textContent = "Произошла ошибка при проверке.";
            });
    });
    </script>
    <!-- авторизация в веб-->
    <button id="web-login-btn" class="btn btn-outline-primary btn-sm">Авторизоваться через Web</button>
                    <div id="web-login-result" class="mt-2 small text-muted"></div>

                    <script>
                    document.getElementById('web-login-btn').addEventListener('click', () => {
                        const deviceId = {{ device.id }};
                        const resultDiv = document.getElementById('web-login-result');

                        resultDiv.textContent = "⏳ Авторизация через Web...";
                        resultDiv.className = "text-info";

                        fetch(`/device/${deviceId}/weblogin/`)
                            .then(response => response.json())
                            .then(data => {
                                resultDiv.textContent = data.status;
                                if (data.redirect) {
                                    resultDiv.innerHTML += `<br><a href="${data.redirect}" target="_blank">Открыть вручную</a>`;
                                }
                                resultDiv.className = data.status.includes("✅") ? "text-success"
                                                    : data.status.includes("⚠") ? "text-warning"
                                                    : "text-danger";
                            })
                            .catch(() => {
                                resultDiv.textContent = "Произошла ошибка при попытке входа.";
                                resultDiv.className = "text-warning";
                            });
                    });
                    </script>


    <!-- Кнопка CLI авторизации -->
<button id="cli-auth-btn" class="btn btn-secondary">Авторизация (CLI)</button>
<div id="cli-auth-result" class="mt-3"></div>

<script>
document.getElementById('cli-auth-btn').addEventListener('click', async function() {
    const resultDiv = document.getElementById('cli-auth-result');
    resultDiv.innerHTML = '<div class="alert alert-info">Попытка подключения через CLI...</div>';

    try {
        const response = await fetch('{% url "cli-auth" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})  // Можно передать device_id при необходимости
        });

        const data = await response.json();

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    Успешно! Ответ сервера: <pre>${data.output}</pre>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    Ошибка: ${data.error}
                </div>
            `;
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                Ошибка сети: ${error.message}
            </div>
        `;
    }
});
<!--&lt;!&ndash;// Простейший работающий запрос для теста&ndash;&gt;-->
<!--document.getElementById('cli-auth-btn').addEventListener('click', function() {-->
<!--    fetch('http://localhost:8000/devices/cli-auth/')-->
<!--    .then(response => response.text())-->
<!--    .then(data => {-->
<!--        document.getElementById('cli-auth-result').innerHTML =-->
<!--            `<pre>${data}</pre>`;-->
<!--    })-->
<!--    .catch(error => {-->
<!--        document.getElementById('cli-auth-result').innerHTML =-->
<!--            `Error: ${error.message}`;-->
<!--    });-->
<!--});-->
</script>

    <!-- Блок 5: Проверка функций -->
    <div class="card mb-4">
        <div class="card-header fw-bold">Проверка функций</div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Функция</th>
                        <th>Указана в документации</th>
                        <th>Поддержка</th>
                        <th>CLI-настройка</th>
                        <th>Web-настройка</th>
                    </tr>
                </thead>
                <tbody>
                {% for f in features %}
                    <tr>
                        <td>
                          {{ f.name }}
                          <br>
                          <a href="{% url 'feature_method' f.id %}" class="small text-decoration-none">Методика тестирования</a>
                        </td>
                        <td>
                          <button class="btn btn-sm btn-outline-primary check-ds-btn"
                                  data-feature-id="{{ f.id }}"
                                  data-device-id="{{ device.id }}">
                            Проверить по Datasheet
                          </button>
                        </td>

                        <td>{% if f.supported %}✅{% else %}❌{% endif %}</td>
                        <td>
                            {% if f.config_cli %}
                                <code>{{ f.config_cli|truncatewords:10 }}</code>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>
                            {% if f.config_web %}
                                <code>{{ f.config_web|truncatewords:10 }}</code>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5" class="text-muted">Нет данных</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        </div>

            <script>
            document.querySelectorAll('.check-ds-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                const deviceId = this.dataset.deviceId;
                const featureId = this.dataset.featureId;
                const button = this;

                button.disabled = true;
                button.textContent = 'Проверка...';

                try {
                  const response = await fetch(`/devices/${deviceId}/check_datasheet/${featureId}/`);
                  if (!response.ok) throw new Error('Ошибка сети');

                  const data = await response.json();

                  if (data.status === 'no_datasheet') {
                    button.textContent = 'Нет Datasheet';
                    button.className = 'btn btn-sm btn-outline-danger disabled';
                  } else if (data.status === 'found') {
                    button.textContent = 'Да';
                    button.className = 'btn btn-sm btn-success disabled';
                  } else if (data.status === 'not_found') {
                    button.textContent = 'Нет';
                    button.className = 'btn btn-sm btn-outline-danger disabled';
                  } else {
                    button.textContent = 'Ошибка';
                    button.className = 'btn btn-sm btn-outline-warning disabled';
                  }
                } catch (e) {
                  button.textContent = 'Ошибка';
                  button.className = 'btn btn-sm btn-outline-warning disabled';
                }
              });
            });
            </script>


</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById('pdf-form');
    if (!form) {
        console.warn('Форма для извлечения PDF не найдена');
        return;
    }

    form.addEventListener('submit', function (e) {
        e.preventDefault(); // Останавливаем стандартную отправку
        const waitBox = document.getElementById('pdf-wait-message');
        waitBox.style.display = 'block'; // Показываем сообщение

        // Через 2 секунды отправляем форму
        setTimeout(() => {
            form.submit();
        }, 2000);
    });
});
</script>

</body>
</html>
